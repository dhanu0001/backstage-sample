version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@8.1.2
  aws-ecs: circleci/aws-ecs@3.1.0
  
workflows:
  build_and_push_image:

    jobs:
      - aws-ecr/build-and-push-image: 
          dockerfile: Dockerfile
          aws-access-key-id: AKIA2VTJ5QJNIOTD2L3Z
          aws-cli-version: latest
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          path: .
          # profile-name: default
          repo: fargate-backstage
          region: us-east-1
          registry-id: AWS_ECR_REGISTRY_ID
          tag: ${CIRCLE_SHA1}
          push-image: true
          platform: linux/amd64
 
      - aws-ecs/deploy-service-update:
          cluster: ${MY_APP_PREFIX}
          container-image-name-updates: 'container=${MY_APP_PREFIX},tag=${CIRCLE_SHA1}'
          family: ${MY_APP_PREFIX}
          service-name: ${MY_APP_PREFIX}
          force-new-deployment: true
          requires:
                - aws-ecr/build-and-push-image
          # context: backstage-integration